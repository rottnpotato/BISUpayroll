generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String                  @id @default(cuid())
  email                        String                  @unique
  password                     String
  firstName                    String
  lastName                     String
  role                         Role                    @default(EMPLOYEE)
  status                       EmploymentStatus        @default(ACTIVE)
  employeeId                   String?                 @unique
  department                   String?
  position                     String?
  hireDate                     DateTime?
  phone                        String?
  address                      String?
  emergencyContactName         String?
  emergencyContactRelationship String?
  emergencyContactPhone        String?
  createdAt                    DateTime                @default(now())
  updatedAt                    DateTime                @updatedAt
  approvedAttendanceRecords    AttendanceRecord[]      @relation("AttendanceApprovedBy")
  attendanceRecords            AttendanceRecord[]
  auditLogs                    AuditLog[]
  approvedLeaves               LeaveRequest[]          @relation("ApprovedBy")
  leaveRequests                LeaveRequest[]
  payrollRecords               PayrollRecord[]
  payrollRules                 PayrollRuleAssignment[]
  payrollResults               PayrollResult[]
  approvedPayrollResults       PayrollResult[]         @relation("PayrollResultApprovedBy")
  generatedPayrollFiles        PayrollFile[]            @relation("PayrollFileGeneratedBy")
  payrollRoles                 UserPayrollRole[]

  @@map("users")
}

model AttendanceRecord {
  id                String           @id @default(cuid())
  userId            String
  date              DateTime         @default(now())
  timeIn            DateTime?
  timeOut           DateTime?
  hoursWorked       Decimal?         @db.Decimal(4, 2)
  isLate            Boolean          @default(false)
  isAbsent          Boolean          @default(false)
  
  // New fields for improved attendance tracking
  sessionType       String?          // 'morning', 'afternoon', 'full_day'
  isHalfDay         Boolean          @default(false)
  isEarlyOut        Boolean          @default(false)
  earlyOutReason    String?
  morningTimeIn     DateTime?
  morningTimeOut    DateTime?
  afternoonTimeIn   DateTime?
  afternoonTimeOut  DateTime?
  totalSessions     Int              @default(0)
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  approvedAt        DateTime?
  approvedById      String?
  rejectionReason   String?
  status            AttendanceStatus @default(PENDING)
  approvedBy        User?            @relation("AttendanceApprovedBy", fields: [approvedById], references: [id])
  user              User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attendance_records")
}

model PayrollRecord {
  id             String    @id @default(cuid())
  userId         String
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  baseSalary     Decimal   @db.Decimal(10, 2)
  overtime       Decimal   @default(0) @db.Decimal(10, 2)
  deductions     Decimal   @default(0) @db.Decimal(10, 2)
  bonuses        Decimal   @default(0) @db.Decimal(10, 2)
  grossPay       Decimal   @db.Decimal(10, 2)
  netPay         Decimal   @db.Decimal(10, 2)
  isPaid         Boolean   @default(false)
  paidAt         DateTime?
  isGenerated    Boolean   @default(false)
  generatedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payroll_records")
}

model PayrollResult {
  id                    String   @id @default(cuid())
  userId                String
  payrollScheduleId     String?
  payPeriodStart        DateTime
  payPeriodEnd          DateTime
  
  // Basic salary information
  baseSalary            Decimal  @db.Decimal(10, 2)
  dailyRate             Decimal  @db.Decimal(10, 2)
  hourlyRate            Decimal  @db.Decimal(10, 2)
  
  // Attendance data
  daysWorked            Int      @default(0)
  hoursWorked           Decimal  @default(0) @db.Decimal(6, 2)
  overtimeHours         Decimal  @default(0) @db.Decimal(6, 2)
  undertimeHours        Decimal  @default(0) @db.Decimal(6, 2)
  lateHours             Decimal  @default(0) @db.Decimal(6, 2)
  holidayHours          Decimal  @default(0) @db.Decimal(6, 2)
  nightShiftHours       Decimal  @default(0) @db.Decimal(6, 2)
  
  // Earnings breakdown
  regularPay            Decimal  @default(0) @db.Decimal(10, 2)
  overtimePay           Decimal  @default(0) @db.Decimal(10, 2)
  holidayPay            Decimal  @default(0) @db.Decimal(10, 2)
  nightDifferential     Decimal  @default(0) @db.Decimal(10, 2)
  allowances            Decimal  @default(0) @db.Decimal(10, 2)
  bonuses               Decimal  @default(0) @db.Decimal(10, 2)
  thirteenthMonthPay    Decimal  @default(0) @db.Decimal(10, 2)
  serviceIncentiveLeave Decimal  @default(0) @db.Decimal(10, 2)
  otherEarnings         Decimal  @default(0) @db.Decimal(10, 2)
  
  // Gross pay
  grossPay              Decimal  @db.Decimal(10, 2)
  
  // Mandatory contributions
  gsisContribution      Decimal  @default(0) @db.Decimal(10, 2)
  philHealthContribution Decimal @default(0) @db.Decimal(10, 2)
  pagibigContribution   Decimal  @default(0) @db.Decimal(10, 2)
  
  // Tax calculations
  taxableIncome         Decimal  @default(0) @db.Decimal(10, 2)
  withholdingTax        Decimal  @default(0) @db.Decimal(10, 2)
  
  // Other deductions
  lateDeductions        Decimal  @default(0) @db.Decimal(10, 2)
  undertimeDeductions   Decimal  @default(0) @db.Decimal(10, 2)
  loanDeductions        Decimal  @default(0) @db.Decimal(10, 2)
  otherDeductions       Decimal  @default(0) @db.Decimal(10, 2)
  
  // Totals
  totalEarnings         Decimal  @db.Decimal(10, 2)
  totalDeductions       Decimal  @db.Decimal(10, 2)
  netPay                Decimal  @db.Decimal(10, 2)
  
  // Status and metadata
  status                PayrollResultStatus @default(GENERATED)
  isApproved            Boolean  @default(false)
  approvedAt            DateTime?
  approvedById          String?
  isPaid                Boolean  @default(false)
  paidAt                DateTime?
  
  // Applied rules (JSON array of rule IDs and calculated amounts)
  appliedRules          String?  // JSON string containing rule applications
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  // Relations
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  approvedBy            User?    @relation("PayrollResultApprovedBy", fields: [approvedById], references: [id])

  @@unique([userId, payPeriodStart, payPeriodEnd])
  @@map("payroll_results")
}

model LeaveRequest {
  id           String      @id @default(cuid())
  userId       String
  type         LeaveType
  startDate    DateTime
  endDate      DateTime
  reason       String?
  status       LeaveStatus @default(PENDING)
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  approvedBy   User?       @relation("ApprovedBy", fields: [approvedById], references: [id])
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("leave_requests")
}

model PayrollRule {
  id            String                  @id @default(cuid())
  name          String                  @unique
  type          String
  amount        Decimal                 @db.Decimal(10, 2)
  isPercentage  Boolean                 @default(false)
  isActive      Boolean                 @default(true)
  description   String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  applyToAll    Boolean                 @default(true)
  assignedUsers PayrollRuleAssignment[]

  @@map("payroll_rules")
}

model PayrollRuleAssignment {
  id            String      @id @default(cuid())
  userId        String
  payrollRuleId String
  createdAt     DateTime    @default(now())
  payrollRule   PayrollRule @relation(fields: [payrollRuleId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, payrollRuleId])
  @@map("payroll_rule_assignments")
}

model PayrollSchedule {
  id                String   @id @default(cuid())
  name              String   @unique
  days              Int[]
  isActive          Boolean  @default(false)
  cutoffDays        Int[]    @default([])
  payrollReleaseDay Int?
  // New field for multiple processing dates (for bi-monthly schedules)
  processingDays    Int[]    @default([])
  cutoffType        String?
  paymentMethod     String?
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("payroll_schedules")
}

model SystemSettings {
  id          String                @id @default(cuid())
  key         String                @unique
  value       String
  description String?
  category    String?               // e.g., 'payroll', 'system', 'security'
  dataType    SettingsDataType      @default(STRING)
  isActive    Boolean               @default(true)
  createdAt   DateTime              @default(now())
  updatedAt   DateTime              @updatedAt
  
  // Configuration scope information
  scopes      ConfigurationScope[]

  @@map("system_settings")
}

model ConfigurationScope {
  id               String         @id @default(cuid())
  settingsId       String
  applicationType  ApplicationType @default(ALL)
  targetId         String?        // Department ID, User ID, etc.
  targetName       String?        // Department name, User name, etc.
  priority         Int            @default(0) // Higher priority overrides lower
  isActive         Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  
  settings         SystemSettings @relation(fields: [settingsId], references: [id], onDelete: Cascade)

  @@map("configuration_scopes")
}

model ContributionBracket {
  id                String   @id @default(cuid())
  contributionType  String   // 'gsis', 'philhealth', 'pagibig'
  salaryMin         Decimal  @db.Decimal(12, 2)
  salaryMax         Decimal  @db.Decimal(12, 2)
  employeeRate      Decimal  @db.Decimal(5, 4) // Percentage as decimal
  employerRate      Decimal  @db.Decimal(5, 4) // Percentage as decimal
  minContribution   Decimal? @db.Decimal(10, 2)
  maxContribution   Decimal? @db.Decimal(10, 2)
  description       String?
  effectiveDate     DateTime @default(now())
  isActive          Boolean  @default(true)
  priority          Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("contribution_brackets")
}

model TaxBracketConfig {
  id            String   @id @default(cuid())
  salaryMin     Decimal  @db.Decimal(12, 2)
  salaryMax     Decimal  @db.Decimal(12, 2)
  taxRate       Decimal  @db.Decimal(5, 4) // Percentage as decimal
  fixedAmount   Decimal  @default(0) @db.Decimal(10, 2)
  description   String
  effectiveDate DateTime @default(now())
  isActive      Boolean  @default(true)
  priority      Int      @default(0)
  source        String   @default("manual") // 'manual', 'api', 'bir'
  apiReference  String?  // Reference to external API source
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("tax_bracket_configs")
}

model Holiday {
  id          String      @id @default(cuid())
  name        String
  date        DateTime
  type        HolidayType @default(REGULAR)
  isRecurring Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([name, date])
  @@map("holidays")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

model PayrollFile {
  id                String   @id @default(cuid())
  fileName          String
  filePath          String
  fileSize          Int      // File size in bytes
  fileType          String   // e.g., "pdf", "excel", "csv"
  reportType        String   // e.g., "monthly", "department", "tax", "custom"
  
  // Payroll period information
  payPeriodStart    DateTime
  payPeriodEnd      DateTime
  
  // Generation metadata
  generatedBy       String   // User ID who generated the report
  generatedAt       DateTime @default(now())
  department        String?  // Department filter used, null if all departments
  employeeCount     Int      // Number of employees included in the report
  
  // Financial summary
  totalGrossPay     Decimal  @db.Decimal(12, 2)
  totalNetPay       Decimal  @db.Decimal(12, 2)
  totalDeductions   Decimal  @db.Decimal(12, 2)
  
  // Status and metadata
  status            PayrollFileStatus @default(GENERATED)
  isArchived        Boolean  @default(false)
  downloadCount     Int      @default(0)
  lastDownloadAt    DateTime?
  
  // Schedule reference (optional)
  scheduleId        String?
  scheduleName      String?
  
  // Additional metadata
  metadata          String?  // JSON string for additional data
  checksum          String?  // File integrity check
  
  // Relations
  generatedByUser   User     @relation("PayrollFileGeneratedBy", fields: [generatedBy], references: [id])
  
  @@map("payroll_files")
}

model PayrollRole {
  id                        String                @id @default(cuid())
  name                      String                @unique
  description               String?
  department                String?
  position                  String?
  isActive                  Boolean               @default(true)
  baseSalary                Decimal?              @db.Decimal(10, 2)
  overtimeEligible          Boolean               @default(true)
  nightDifferentialEligible Boolean               @default(true)
  holidayPayEligible        Boolean               @default(true)
  gsisEligible              Boolean               @default(true)
  philHealthEligible        Boolean               @default(true)
  pagibigEligible           Boolean               @default(true)
  withholdingTaxEligible    Boolean               @default(true)
  thirteenthMonthEligible   Boolean               @default(true)
  leaveEligible             Boolean               @default(true)
  createdAt                 DateTime              @default(now())
  updatedAt                 DateTime              @updatedAt
  userRoles                 UserPayrollRole[]

  @@map("payroll_roles")
}

model UserPayrollRole {
  id            String      @id @default(cuid())
  userId        String
  payrollRoleId String
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  payrollRole   PayrollRole @relation(fields: [payrollRoleId], references: [id], onDelete: Cascade)

  @@unique([userId, payrollRoleId])
  @@map("user_payroll_roles")
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  OTHER
}

enum HolidayType {
  REGULAR
  SPECIAL
  LOCAL
}

enum AttendanceStatus {
  PENDING
  APPROVED
  REJECTED
}

enum PayrollResultStatus {
  GENERATED
  APPROVED
  REJECTED
  PAID
}

enum PayrollFileStatus {
  GENERATED
  APPROVED
  REJECTED
  ARCHIVED
}

enum SettingsDataType {
  STRING
  NUMBER
  BOOLEAN
  JSON
  DECIMAL
}

enum ApplicationType {
  ALL
  DEPARTMENT
  INDIVIDUAL
  ROLE
  POSITION
}
