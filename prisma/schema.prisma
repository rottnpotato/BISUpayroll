generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                           String                  @id @default(cuid())
  email                        String                  @unique
  password                     String
  firstName                    String
  lastName                     String
  role                         Role                    @default(EMPLOYEE)
  status                       EmploymentStatus        @default(ACTIVE)
  employeeId                   String?                 @unique
  department                   String?
  position                     String?
  hireDate                     DateTime?
  salary                       Decimal?                @db.Decimal(10, 2)
  phone                        String?
  address                      String?
  emergencyContactName         String?
  emergencyContactRelationship String?
  emergencyContactPhone        String?
  createdAt                    DateTime                @default(now())
  updatedAt                    DateTime                @updatedAt
  approvedAttendanceRecords    AttendanceRecord[]      @relation("AttendanceApprovedBy")
  attendanceRecords            AttendanceRecord[]
  auditLogs                    AuditLog[]
  approvedLeaves               LeaveRequest[]          @relation("ApprovedBy")
  leaveRequests                LeaveRequest[]
  payrollRecords               PayrollRecord[]
  payrollRules                 PayrollRuleAssignment[]

  @@map("users")
}

model AttendanceRecord {
  id              String           @id @default(cuid())
  userId          String
  date            DateTime         @default(now())
  timeIn          DateTime?
  timeOut         DateTime?
  hoursWorked     Decimal?         @db.Decimal(4, 2)
  isLate          Boolean          @default(false)
  isAbsent        Boolean          @default(false)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  approvedAt      DateTime?
  approvedById    String?
  rejectionReason String?
  status          AttendanceStatus @default(PENDING)
  approvedBy      User?            @relation("AttendanceApprovedBy", fields: [approvedById], references: [id])
  user            User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("attendance_records")
}

model PayrollRecord {
  id             String    @id @default(cuid())
  userId         String
  payPeriodStart DateTime
  payPeriodEnd   DateTime
  baseSalary     Decimal   @db.Decimal(10, 2)
  overtime       Decimal   @default(0) @db.Decimal(10, 2)
  deductions     Decimal   @default(0) @db.Decimal(10, 2)
  bonuses        Decimal   @default(0) @db.Decimal(10, 2)
  grossPay       Decimal   @db.Decimal(10, 2)
  netPay         Decimal   @db.Decimal(10, 2)
  isPaid         Boolean   @default(false)
  paidAt         DateTime?
  isGenerated    Boolean   @default(false)
  generatedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payroll_records")
}

model LeaveRequest {
  id           String      @id @default(cuid())
  userId       String
  type         LeaveType
  startDate    DateTime
  endDate      DateTime
  reason       String?
  status       LeaveStatus @default(PENDING)
  approvedById String?
  approvedAt   DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  approvedBy   User?       @relation("ApprovedBy", fields: [approvedById], references: [id])
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("leave_requests")
}

model PayrollRule {
  id            String                  @id @default(cuid())
  name          String                  @unique
  type          String
  amount        Decimal                 @db.Decimal(10, 2)
  isPercentage  Boolean                 @default(false)
  isActive      Boolean                 @default(true)
  description   String?
  createdAt     DateTime                @default(now())
  updatedAt     DateTime                @updatedAt
  applyToAll    Boolean                 @default(true)
  assignedUsers PayrollRuleAssignment[]

  @@map("payroll_rules")
}

model PayrollRuleAssignment {
  id            String      @id @default(cuid())
  userId        String
  payrollRuleId String
  createdAt     DateTime    @default(now())
  payrollRule   PayrollRule @relation(fields: [payrollRuleId], references: [id], onDelete: Cascade)
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, payrollRuleId])
  @@map("payroll_rule_assignments")
}

model PayrollSchedule {
  id                String   @id @default(cuid())
  name              String   @unique
  days              Int[]
  isActive          Boolean  @default(false)
  cutoffDays        Int[]    @default([])
  payrollReleaseDay Int?
  // New field for multiple processing dates (for bi-monthly schedules)
  processingDays    Int[]    @default([])
  cutoffType        String?
  paymentMethod     String?
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@map("payroll_schedules")
}

model SystemSettings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("system_settings")
}

model Holiday {
  id          String      @id @default(cuid())
  name        String
  date        DateTime
  type        HolidayType @default(REGULAR)
  isRecurring Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([name, date])
  @@map("holidays")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String?
  details    String?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       User?    @relation(fields: [userId], references: [id])

  @@map("audit_logs")
}

enum Role {
  ADMIN
  EMPLOYEE
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  TERMINATED
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LeaveType {
  VACATION
  SICK
  PERSONAL
  BEREAVEMENT
  OTHER
}

enum HolidayType {
  REGULAR
  SPECIAL
  LOCAL
}

enum AttendanceStatus {
  PENDING
  APPROVED
  REJECTED
}
